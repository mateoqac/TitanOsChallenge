#!/usr/bin/env bash

# Script para ejecutar tests con Docker PostgreSQL
set -e

echo "ğŸš€ Configurando entorno de test con Docker..."

# Asegurar que Docker estÃ© corriendo
if ! docker info > /dev/null 2>&1; then
  echo "âŒ Docker no estÃ¡ corriendo. Por favor inicia Docker y vuelve a intentar."
  exit 1
fi

# Variables de entorno para test
export RAILS_ENV=test
export DATABASE_HOST=localhost
export DATABASE_USERNAME=postgres
export DATABASE_PASSWORD=postgres

# Verificar si el contenedor de PostgreSQL estÃ¡ corriendo
if ! docker ps | grep -q "postgres:16"; then
  echo "ğŸ“¦ Iniciando contenedor de PostgreSQL..."
  docker compose up -d db

  # Esperar a que PostgreSQL estÃ© listo
  echo "â³ Esperando a que PostgreSQL estÃ© listo..."
  until docker compose exec -T db pg_isready -U postgres; do
    sleep 1
  done
  echo "âœ… PostgreSQL estÃ¡ listo!"
else
  echo "âœ… Contenedor de PostgreSQL ya estÃ¡ corriendo"
fi

# Crear y configurar la base de datos de test
echo "ğŸ—„ï¸  Configurando base de datos de test..."
bundle exec rails db:create RAILS_ENV=test
bundle exec rails db:migrate RAILS_ENV=test

# Ejecutar los tests
echo "ğŸ§ª Ejecutando tests..."
bundle exec rspec "$@"

echo "âœ… Tests completados!"
